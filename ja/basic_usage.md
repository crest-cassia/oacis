---
layout: default
title: "基本の使い方"
lang: ja
---

# {{ page.title }}

簡単なシミュレータを実際に実行し、結果を参照するまでの最小の手順をここで示す。

---

## 手順

1. ここで扱うシミュレータについて
1. Host登録
1. Simulator登録
1. ParameterSet登録
1. ジョブ投入
1. 実行中のジョブの確認
1. 結果の確認

#### ここで扱うシミュレータについて

このチュートリアルでは、２つの浮動小数点型のパラメータ"p1", "p2"を持つとする。
このシミュレータは以下の様にパラメータと乱数の種を引数で受け取り実行できるように、各実行ホストでビルドをしておく。

```
~/path/to/simulator.out {p1} {p2} {seed}
```

パラメータをシミュレータに渡す方法として、JSONで渡す方法もある。Simulator登録の項目を参照の事。

## Host登録

シミュレータを実行するためのホストを登録する。
前提条件として、サーバーからシミュレータを実行するホストに鍵認証を使用してパスワード無しでSSHログインできるようにしておかなくてはいけない。
ここでは鍵認証でリモートホストにSSHログインできるという前提で話を進める。
また、ホストでジョブスケジューラ(xsub) が実行可能でなければならない。
xsub の設定方法については、https://github.com/crest-cassia/xsub を参照すること。

ナビゲーションバーの[Hosts]をクリックし、[New Hosts]のボタンを押すと新規Host登録画面が表示される。

![ホスト登録]({{ site.baseurl }}/images/hosts.png){:width="400px"}

このページの入力フィールドにホストの情報を登録する。登録する項目は以下の通り。

|----------------------------|---------------------------------------------------------------------|
| フィールド                 | 説明                                                                |
|:---------------------------|:--------------------------------------------------------------------|
| Name                       | OACISの中で使われるHostの名前。任意の名前を指定できる。一意でなくてはならない。 |
| Hostname                   | ssh接続先のhostnameまたはIPアドレス。 |
| User                       | ssh接続時に使用するユーザー名。 |
| Port                       | ssh接続先のポート番号。デフォルトは22。 |
| SSH key                    | ssh接続時の鍵認証で使用する秘密鍵ファイルへのパス。デフォルトは *~/.ssh/id_rsa* |
| Scheduler Type             | ジョブスケジューラのタイプ。none(スケジューラ無し)、xsubから選択する。（その他はv1.14.0で廃止予定） |
| Work base dir              | ワークディレクトリとして利用するホスト上のパス。ここで指定したパス以下でジョブが実行される。 |
| Mounted work base dir      | localhostでジョブを実行する場合やホームディレクトリがNFSで共有されている場合など、直接ワークディレクトリが参照できる場合、ここで指定したディレクトリから直接ジョブの取り込みが行われパフォーマンスが向上する。 |
| Max num jobs               | このホストに投入可能なジョブの最大数。 |
| MPI processes              | MPIプロセス数の最小値と最大値。Runを作成するときにここで指定した範囲外の値を指定しようとするとエラーになる。 |
| OMP threads                | OMPスレッド数の最小値と最大値。Runを作成するときにここで指定した範囲外の値を指定しようとするとエラーになる。 |
| Executable simulators      | 実行可能なシミュレータをチェックボックスで指定。 |
|----------------------------|---------------------------------------------------------------------|

## システム構成

OACISは、Ruby on Railsフレームワークを用いて構築されており、ユーザーはウェブブラウザを用いて実行したシミュレーション結果などにアクセスすることができる。
内部のデータベースとしてMongoDBを使用しており、シミュレーション実行時の情報、パラメータについての情報、ホストについての情報などが格納される。
シミュレータが出力したファイルやディレクトリについては、ファイルシステム上(publicディレクトリ以下)に保存される。
システム構成の概要は下図のようになる。

![システム構成]({{ site.baseurl }}/images/system_configuration_num.png){:width="400px"}

ユーザーがシミュレーション実行をリクエストしてから、シミュレーション結果をOACISに保存するまでの処理の流れに沿ってシステムの概要を説明する。

1. まずユーザーがウェブブラウザ（①）上で実行したいシミュレーションを指定する。
1. リクエストはウェブサーバー上（②）で処理され、Workerと呼ばれるデーモンプロセス（③）に処理を依頼する。
  * Workerとはバックグラウンドで、リモートホストへのSSH接続やファイル転送などの時間がかかる処理を担当するプロセスである。
1. Workerはユーザーによって指定されたシミュレーションをリモートホスト（④）で実行する。
  * Host登録時にTorqueなどのジョブスケジューラを指定すれば、ジョブスケジューラ経由でジョブが実行される。
  * シミュレータは事前にユーザーが各ホスト上でビルドして実行可能な状態になっている必要がある。
    * 事前にシミュレータのパスをOACISに登録し、Workerがそのコマンドをリモートホストで実行する。
  * 各ジョブごとにディレクトリを作成し、その中でジョブが実行される。
1. リモートホストでの実行が完了後、Workerが実行結果をOACIS実行サーバーにSFTPでダウンロードする。
  * Workerが定期的にリモートホストをポーリングし、ジョブが完了したかどうか確認する。
  * 結果はファイルストレージ（⑤）およびDB（⑥）に格納される。


格納された結果はブラウザからアクセス可能となる。

## データ構造の概略

OACISではシミュレーション結果は図の様なSimulator, ParameterSet, Runの３層構造に分けて保存される。

![データ構造]({{ site.baseurl }}/images/data_structure.png){:width="400px"}

Simulatorは複数のParameterSetを持ち、ParameterSetは複数のRunを持っている。
ParameterSetとはあるシミュレータを実行するのに必要なパラメータの値の組をさす概念で、Runとは独立なモンテカルロランの一つをさす概念である。

例として、単純な交通流シミュレータを考えよう。
この交通流シミュレータは、道路の長さL、信号周期T、車の台数Nを入力パラメータに持つシミュレータだとする。
ParameterSetとは、{L=100, T=10, N=10} などのパラメータの組み合わせのことをさす。
このパラメータセットで乱数の種を変えて５回シミュレーションを行うとすると、５つのRunが作成されることになる。

またそれぞれの結果に対して解析を実施する事もできる。
その際には図のように解析対象（ParameterSet または Run）の配下に解析結果が格納される。

