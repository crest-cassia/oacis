---
layout: default
title: "ホストの設定"
lang: ja
next_page: configuring_simulator
---

# {{ page.title }}

このページではリモートホストを各環境に合わせて設定する方法について説明していきます。
リモートホストは、OACIS実行ホストから(1)パスワードなしでSSH接続でき、(2)xsub導入済みであることが必要です。

* TOC
{:toc}

---

## ジョブスケジューラ経由でのジョブ投入の仕組みについて

一般的にHPCやクラスタを使用するときにはTorqueなどのジョブスケジューラを経由してジョブを実行します。

ジョブスケジューラに投入する際には確保するノード数などを指定して実行する必要がありますが、ジョブの投入方法やパラメータの指定方法がシステムによって大きく異なります。
そこでOACISではジョブスケジューラの差異を吸収するために、 [xsub](https://github.com/crest-cassia/xsub) というラッパスクリプトを経由してジョブ投入します。
xsubは各実行ホストに事前に設定しておく必要があります。

xsubの導入方法は[xsub](https://github.com/crest-cassia/xsub)のページを参照してください。
インストール後には **xsub**, **xstat**, **xdel** というコマンドが利用可能になっているはずです。

（注）OACISはこれらのコマンドをbashのログインシェルから実行します。
(`bash -l`コマンド経由で実行される。）
PATHなどの環境変数の設定は".bash\_profile"で行ってください。

![xsubの概念図]({{ site.baseurl }}/images/xsub.png){:width="500px"}

ジョブ投入時に指定する必要があるパラメータ（ノード数など）を"ホストパラメータ"と呼んでいます。
スケジューラのタイプごとに指定するホストパラメータは異なりますが、OACISはHostを登録する際に必要なホストパラメータについての情報をリモートホストのxsubコマンドから取得します。
つまりOACISのウェブUIでホストを登録する前に、リモートホスト側でxsubのセットアップを完了している必要があります。
ここで取得されたホストパラメータはRunの作成時に指定できるようになります。
下図のように、Runを作成する際に入力用のフォームが現れます。

![ホストパラメータを指定してのRun作成]({{ site.baseurl }}/images/new_run_with_host_params.png){:width="600px"}

## Hostの仕様 {#host_specification}

OACISにリモートホストを登録する時に設定する項目について説明します。

|----------------------------|---------------------------------------------------------------------|
| フィールド                 | 説明                                                                |
|:---------------------------|:--------------------------------------------------------------------|
| Name                       | OACISの中で使われるHostの名前。任意の名前を指定できる。一意でなくてはならない。 |
| Hostname                   | ssh接続先のhostnameまたはIPアドレス。 |
| Polling Status             | サーバーを使用するかどうかのフラグ。サーバーのメンテナンス時など、一時的にジョブの投入を止めたい場合に disabled を指定する。 |
| User                       | ssh接続時に使用するユーザー名。 |
| Port                       | ssh接続先のポート番号。デフォルトは22。 |
| SSH key                    | ssh接続時の鍵認証で使用する秘密鍵ファイルへのパス。デフォルトは *~/.ssh/id_rsa* |
| Work base dir              | ワークディレクトリとして利用するホスト上のパス。ここで指定したパス以下でジョブが実行される。 |
| Mounted work base dir      | localhostでジョブを実行する場合やホームディレクトリがNFSで共有されている場合など、OACISが実行中のサーバーからWork base dirを直接参照できる場合のパス。マウントされていない場合は空白にしておく |
| Max num jobs               | このホストに投入可能なジョブの最大数。 |
| Polling interval           | ジョブのステータスを確認するインターバル。ここで指定した時間間隔でSSH接続しジョブの状態を確認する。 |
| MPI processes              | MPIプロセス数の最小値と最大値。Runを作成するときにここで指定した範囲外の値を指定しようとするとエラーになる。 |
| OMP threads                | OMPスレッド数の最小値と最大値。Runを作成するときにここで指定した範囲外の値を指定しようとするとエラーになる。 |
| Executable simulators      | 実行可能なSimulatorをチェックボックスで指定。 |
| Executable analyzers       | 実行可能なAnalyzerをチェックボックスで指定。 |
|----------------------------|---------------------------------------------------------------------|

{% capture tips %}
Mounted work base dirを指定するとホストとのファイル転送にSFTP接続ではなく、マウントされたパスからコピーを行います。パフォーマンスが向上する場合があります。
localhostを指定する場合には、Work base dirと同じ値を指定するとよいです。
{% endcapture %}{% include tips %}

ホスト登録時に"no such command xsub" というエラーが発生した場合は、そのホストでXSUBの設定を確認してください。正しく設定されていれば、OACISのマシンの端末から下記のコマンドを実行するとリモートホストの設定が取得できるはずです。

## 京コンピュータを利用するケース

京コンピュータでジョブを実行する場合、実行するシミュレーターのファイルもステージングする必要があるため、他のホストとは異なる設定が必要になります。

実行コマンドは絶対パスやホームディレクトリからの相対パスで指定する事はできません。ステージング後のパスが異なるためです。
そこで、プリプロセスを使って実行ファイルをカレントディレクトリにコピーし、実行コマンドはカレントディレクトリからの相対パスで指定するようにします。

実行ファイルが `~/path/to/simulator.out` にある場合、プリプロセスには以下のように書きます。

```shell
cp ~/path/to/simulator.out .
```

xsubで実行すると、各ワークディレクトリが丸ごとステージインされるので、必要なファイルはすべてカレントディレクトリに事前にコピーしておきます。

実行コマンドは以下のように指定します。

```shell
./simulator.out
```

このように設定しておけば、xsubがカレントディレクトリを丸ごとステージインして実行してくれる。
実行結果は、他のホストの場合と同様にカレントディレクトリ以下に配置しておけば、ステージアウトして結果を取り込んでくれるので、特にステージアウトするファイルを指定する必要はありません。

また京に対してもxsubを導入する必要があります。現時点でxsubはrubyで実装されているので、ログインノードにrubyをインストールする必要があります。
rbenvやrvmなどのツールを使用すると比較的簡単にRubyを導入することができます。

## ジョブスケジューラを経由せず手動でジョブを実行する

OACIS上でRunを作るとworkerによってジョブ投入が自動で行われるが、ジョブの実行を手動で行う事もできます。
Run作成時に投入先Hostとして**manual submission**を指定した場合、自動ジョブ投入は行われずジョブスクリプトの生成のみ行われます。
そのジョブスクリプトをユーザーが手動で実行し、結果を後からOACISに取り込む事ができます。

手動で実行することにより、手間は増えるが細かなスクリプトのカスタマイズが可能になります。
例えば、以下のようなユースケースが考えられます。

- 複数のRunを一つのジョブとしてスケジューラに投入する場合
    - スケジューラのジョブ数に制限がある場合などにまとめて投入する事ができる
        - 例：バルクジョブ
- スケジューラの制限時間よりも長いジョブを実行する場合
    - 一度の実行ではジョブが完了せずジョブのリスタートが必要になる場合には、一つのRunに対して複数回ジョブ投入が必要になる
- スケジューラに投入するジョブスクリプトに特殊な設定が必要な場合
    - OACISによって生成されたスクリプトを手動で編集する事によって、実効方法をカスタマイズできる

Runの作成後に *${OACIS_ROOT}/public/Result_development/manual_submission* ディレクトリにシェルスクリプトが生成されます。
パラメータの入力形式がJSON形式の場合には、入力用JSONファイルも作成される。

![manual submission]({{ site.baseurl }}/images/manual_submission.png){:width="400px"}

ユーザーが以下のように生成されたジョブスクリプト実行すると、ジョブが実行されます。

```shell
bash 52cde935b93f969b07000005.sh
```

シミュレーション実行結果のファイル（今回の例の場合 52cde935b93f969b07000005.tar.bz2）は以下のコマンドでデータベースに取り込む事ができます。

```shell
./bin/oacis_cli job_include -i 52cde935b93f969b07000005.tar.bz2
```

上記コマンドの入力ファイルはスペース区切りまたはコンマ区切りで複数ファイルを指定できます。

